<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåä Mechanical Waves - Physics Live Lab</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root { 
            --primary: #3B82F6; 
            --secondary: #8B5CF6;
            --success: #10B981; 
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #0a0a0f; 
            --panel: rgba(15, 23, 42, 0.9); 
            --text: #f8fafc; 
            --text-muted: #94a3b8;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
        }
        
        #info { 
            position: absolute; 
            top: 20px; 
            width: 100%; 
            text-align: center; 
            pointer-events: none; 
            z-index: 10; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
        }
        
        h1 { 
            margin: 0; 
            font-size: 2rem; 
            font-weight: 700; 
            letter-spacing: -0.5px; 
            background: linear-gradient(135deg, #3B82F6, #8B5CF6, #EC4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle { 
            font-size: 1rem; 
            opacity: 0.8; 
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .wave-info {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel);
            backdrop-filter: blur(12px);
            padding: 12px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 30px;
            z-index: 10;
        }
        
        .wave-stat {
            text-align: center;
        }
        
        .wave-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .wave-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mission-panel {
            position: absolute; 
            top: 30px; 
            right: 30px;
            background: var(--panel); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 24px; 
            border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.1);
            width: 300px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .mission-header { 
            font-weight: 700; 
            color: var(--success); 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 1.1rem;
        }
        
        .mission-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 0.9rem; 
            margin-bottom: 12px; 
            opacity: 0.9;
            transition: opacity 0.3s;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
        }
        
        .mission-item:hover {
            background: rgba(255,255,255,0.08);
        }
        
        .mission-item.completed {
            opacity: 0.6;
        }
        
        .mission-checkbox { 
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--success); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .mission-checkbox.completed { 
            background: var(--success); 
            transform: scale(1.1);
        }
        
        .mission-checkbox.completed::after { 
            content: '‚úì'; 
            color: white; 
            font-size: 12px; 
            font-weight: bold; 
        }

        .controls-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-height: 55vh;
            overflow-y: auto;
        }
        
        .controls-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .controls-panel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        
        .controls-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        
        .control-section {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 12px;
        }
        
        .control-section:last-of-type {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }
        
        .value-display {
            color: var(--primary);
            font-weight: 700;
        }
        
        input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--primary);
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }
        
        .wave-type-selector, .wave-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .wave-type-btn, .wave-mode-btn {
            flex: 1;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .wave-type-btn.active, .wave-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .wave-type-btn:hover:not(.active), .wave-mode-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        button:hover { 
            filter: brightness(1.1); 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        button:active { 
            transform: translateY(0); 
        }
        
        button.secondary {
            background: rgba(255,255,255,0.1);
        }
        
        button.secondary:hover {
            background: rgba(255,255,255,0.15);
            box-shadow: none;
        }
        
        button.hint-btn {
            background: linear-gradient(135deg, var(--secondary), #EC4899);
            position: fixed;
            bottom: 20px;
            left: 320px;
            width: auto;
            padding: 10px 18px;
            z-index: 20;
            font-size: 0.85rem;
        }
        
        .formula-display {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 6px;
        }
        
        .formula-display .highlight {
            color: var(--success);
            font-weight: 600;
        }
        
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .success-content {
            text-align: center;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-content h2 {
            font-size: 3rem;
            margin: 0;
            background: linear-gradient(135deg, var(--success), #34D399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .success-content p {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: var(--panel);
            backdrop-filter: blur(12px);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }
        
        .legend-color.crest { background: #3B82F6; }
        .legend-color.trough { background: #EF4444; }
        .legend-color.equilibrium { background: #10B981; }
        .legend-color.wave1 { background: #3B82F6; }
        .legend-color.wave2 { background: #F59E0B; }
        
        /* Hint Modal */
        .hint-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        
        .hint-content {
            background: var(--panel);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .hint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .hint-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }
        
        .hint-section {
            margin-bottom: 24px;
        }
        
        .hint-section h3 {
            color: var(--secondary);
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hint-section p {
            color: var(--text-muted);
            line-height: 1.6;
            margin: 0;
        }
        
        .hint-section ul {
            color: var(--text-muted);
            line-height: 1.8;
            padding-left: 20px;
        }
        
        .hint-section li {
            margin-bottom: 8px;
        }
        
        .formula-box {
            background: rgba(0,0,0,0.4);
            padding: 16px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            margin: 12px 0;
            border-left: 3px solid var(--primary);
        }
        
        .wave-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 50;
        }
        
        .wave-indicator.show {
            opacity: 1;
        }
        
        .collision-zone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 2px dashed var(--warning);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .collision-zone.show {
            opacity: 0.5;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>üåä Mechanical Waves Lab</h1>
        <p class="subtitle">Interactive Wave Physics ‚Ä¢ Transverse & Longitudinal ‚Ä¢ Wave Collision</p>
    </div>
    
    <div class="wave-info">
        <div class="wave-stat">
            <div class="wave-stat-value" id="waveSpeed">0.0</div>
            <div class="wave-stat-label">Wave Speed (m/s)</div>
        </div>
        <div class="wave-stat">
            <div class="wave-stat-value" id="frequency">0.0</div>
            <div class="wave-stat-label">Frequency (Hz)</div>
        </div>
        <div class="wave-stat">
            <div class="wave-stat-value" id="wavelength">0.0</div>
            <div class="wave-stat-label">Wavelength (m)</div>
        </div>
    </div>
    
    <div class="wave-indicator" id="collisionIndicator">üí• WAVE COLLISION!</div>

    <!-- Mission/Accomplishments Panel -->
    <div class="mission-panel">
        <div class="mission-header">üéØ MISSIONS</div>
        <div class="mission-item" id="missionItem1">
            <div class="mission-checkbox" id="mission1"></div>
            <span>Create wave with Œª > 3m</span>
        </div>
        <div class="mission-item" id="missionItem2">
            <div class="mission-checkbox" id="mission2"></div>
            <span>Achieve wave speed > 5 m/s</span>
        </div>
        <div class="mission-item" id="missionItem3">
            <div class="mission-checkbox" id="mission3"></div>
            <span>Switch to Longitudinal wave</span>
        </div>
        <div class="mission-item" id="missionItem4">
            <div class="mission-checkbox" id="mission4"></div>
            <span>Observe standing wave pattern</span>
        </div>
        <div class="mission-item" id="missionItem5">
            <div class="mission-checkbox" id="mission5"></div>
            <span>üî• Observe Wave Collision!</span>
        </div>
    </div>

    <div class="controls-panel">
        <div class="control-section">
            <div class="section-title">Wave Mode</div>
            <div class="wave-mode-selector">
                <button class="wave-mode-btn active" id="btnSingle" onclick="setWaveMode('single')">Single Wave</button>
                <button class="wave-mode-btn" id="btnCollision" onclick="setWaveMode('collision')">Collision Mode</button>
            </div>
        </div>
        
        <div class="control-section">
            <div class="section-title">Wave Type</div>
            <div class="wave-type-selector">
                <button class="wave-type-btn active" id="btnTransverse" onclick="setWaveType('transverse')">Transverse</button>
                <button class="wave-type-btn" id="btnLongitudinal" onclick="setWaveType('longitudinal')">Longitudinal</button>
            </div>
        </div>
        
        <div class="control-section">
            <div class="section-title">Wave Parameters</div>
            <div class="control-group">
                <label>Amplitude (A) <span class="value-display" id="valAmplitude">0.5 m</span></label>
                <input type="range" id="amplitude" min="0.1" max="2.0" value="0.5" step="0.1">
            </div>
            <div class="control-group">
                <label>Frequency (f) <span class="value-display" id="valFrequency">1.0 Hz</span></label>
                <input type="range" id="frequencyInput" min="0.1" max="5.0" value="1.0" step="0.1">
            </div>
            <div class="control-group">
                <label>Wave Number (k) <span class="value-display" id="valWaveNumber">2.0 rad/m</span></label>
                <input type="range" id="waveNumber" min="0.5" max="4.0" value="2.0" step="0.1">
            </div>
        </div>
        
        <div class="control-section">
            <div class="section-title">String Properties</div>
            <div class="control-group">
                <label>Tension (T) <span class="value-display" id="valTension">10 N</span></label>
                <input type="range" id="tension" min="1" max="50" value="10" step="1">
            </div>
            <div class="control-group">
                <label>Linear Density (Œº) <span class="value-display" id="valDensity">0.1 kg/m</span></label>
                <input type="range" id="density" min="0.01" max="1.0" value="0.1" step="0.01">
            </div>
            <div class="formula-display">
                v = ‚àö(T/Œº) = <span class="highlight" id="calcSpeed">10.0</span> m/s
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="togglePause()" id="pauseBtn" class="secondary" style="flex: 1;">‚è∏ Pause</button>
            <button onclick="resetSimulation()" style="flex: 1;">üîÑ Reset</button>
        </div>
    </div>
    
    <!-- Hint Button -->
    <button class="hint-btn" onclick="openHintModal()">
        üí° Concepts & Hints
    </button>
    
    <!-- Hint Modal -->
    <div class="hint-modal" id="hintModal">
        <div class="hint-content">
            <div class="hint-header">
                <h2>üìö Wave Physics Guide</h2>
                <button class="close-btn" onclick="closeHintModal()">√ó</button>
            </div>
            
            <div class="hint-section">
                <h3>üåä What are Mechanical Waves?</h3>
                <p>Mechanical waves are disturbances that propagate through a medium (like a string). They transfer energy without transferring matter. There are two main types:</p>
                <ul>
                    <li><strong>Transverse Waves:</strong> Particles oscillate perpendicular to wave direction (creates crests and troughs)</li>
                    <li><strong>Longitudinal Waves:</strong> Particles oscillate parallel to wave direction (creates compressions and rarefactions)</li>
                </ul>
            </div>
            
            <div class="hint-section">
                <h3>üìê Key Equations</h3>
                <div class="formula-box">
                    <strong>Wave Equation:</strong> y(x,t) = A sin(kx - œât + œÜ)<br><br>
                    <strong>Wave Speed:</strong> v = ‚àö(T/Œº)<br><br>
                    <strong>Wavelength:</strong> Œª = 2œÄ/k<br><br>
                    <strong>Frequency:</strong> f = œâ/(2œÄ) = v/Œª
                </div>
            </div>
            
            <div class="hint-section">
                <h3>üéØ Mission Hints</h3>
                <ul>
                    <li><strong>Œª > 3m:</strong> Decrease wave number k (Œª = 2œÄ/k)</li>
                    <li><strong>Speed > 5 m/s:</strong> Increase tension T or decrease density Œº</li>
                    <li><strong>Longitudinal:</strong> Click the "Longitudinal" button</li>
                    <li><strong>Standing Wave:</strong> Set frequency > 2 Hz and wave number > 2.5</li>
                    <li><strong>Wave Collision:</strong> Switch to "Collision Mode" and watch waves from both ends meet!</li>
                </ul>
            </div>
            
            <div class="hint-section">
                <h3>üí° Pro Tips</h3>
                <ul>
                    <li>Use <strong>Collision Mode</strong> to see wave interference and superposition</li>
                    <li>When two waves meet, they pass through each other unchanged</li>
                    <li>At the collision point, displacements add up (superposition principle)</li>
                    <li>Try different amplitudes to see how wave energy affects collision</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color wave1"></div>
            <span>Wave from Left (Blue)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color wave2"></div>
            <span>Wave from Right (Orange)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color equilibrium"></div>
            <span>Equilibrium Position</span>
        </div>
    </div>
    
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <h2>üèÜ Mission Accomplished!</h2>
            <p>All missions completed! You're a Wave Master!</p>
        </div>
    </div>

    <script>
        let scene, camera, renderer, controls;
        let waveParticles = [];
        let waveParticles2 = []; // For second wave in collision mode
        let poles = [];
        let animationId;
        let time = 0;
        let isPaused = false;
        let collisionDetected = false;
        let collisionTimer = 0;
        
        // Wave parameters
        let waveParams = {
            type: 'transverse', // 'transverse' or 'longitudinal'
            mode: 'single', // 'single' or 'collision'
            amplitude: 0.5,
            frequency: 1.0,
            waveNumber: 2.0,
            tension: 10,
            density: 0.1,
            phase: 0
        };
        
        // Mission tracking
        let missions = {
            mission1: false,
            mission2: false,
            mission3: false,
            mission4: false,
            mission5: false
        };
        
        // Constants
        const NUM_PARTICLES = 100;
        const STRING_LENGTH = 20;
        const PARTICLE_SPACING = STRING_LENGTH / NUM_PARTICLES;

        function init() {
            // 1. Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050508);
            scene.fog = new THREE.Fog(0x050508, 20, 100);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 28);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // 4. Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2;
            controls.minDistance = 10;
            controls.maxDistance = 60;

            // 5. Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 1.2);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);
            
            // Add colored point lights for atmosphere
            const pointLight1 = new THREE.PointLight(0x3B82F6, 0.6, 50);
            pointLight1.position.set(-12, 5, 5);
            scene.add(pointLight1);
            
            const pointLight2 = new THREE.PointLight(0xF59E0B, 0.6, 50);
            pointLight2.position.set(12, 5, 5);
            scene.add(pointLight2);
            
            const pointLight3 = new THREE.PointLight(0x8B5CF6, 0.4, 40);
            pointLight3.position.set(0, 10, 0);
            scene.add(pointLight3);

            // 6. Helpers (Grid/Axes)
            const gridHelper = new THREE.GridHelper(40, 40, 0x333333, 0x1a1a1a);
            gridHelper.position.y = -4;
            scene.add(gridHelper);
            
            // Add axis labels
            createAxisLabels();
            
            // 7. Create Poles
            createPoles();
            
            // 8. Simulation Objects
            createWaveString();
            createEquilibriumLine();

            // 9. Event Listeners
            window.addEventListener('resize', onWindowResize, false);
            setupUI();

            // 10. Start Loop
            animate();
            
            // Initial calculation
            updateCalculations();
        }
        
        function createPoles() {
            // Remove existing poles
            poles.forEach(p => scene.remove(p));
            poles = [];
            
            const poleHeight = 6;
            const poleRadius = 0.3;
            const poleX = STRING_LENGTH / 2 + 1;
            
            // Pole geometry and materials
            const poleGeometry = new THREE.CylinderGeometry(poleRadius, poleRadius, poleHeight, 32);
            const baseGeometry = new THREE.CylinderGeometry(poleRadius * 2, poleRadius * 2.5, 0.5, 32);
            
            // Left pole (Blue - Wave 1 source)
            const leftPoleMat = new THREE.MeshStandardMaterial({ 
                color: 0x3B82F6,
                emissive: 0x3B82F6,
                emissiveIntensity: 0.2,
                metalness: 0.8,
                roughness: 0.2
            });
            const leftPole = new THREE.Mesh(poleGeometry, leftPoleMat);
            leftPole.position.set(-poleX, poleHeight / 2 - 2, 0);
            leftPole.castShadow = true;
            scene.add(leftPole);
            poles.push(leftPole);
            
            const leftBase = new THREE.Mesh(baseGeometry, leftPoleMat);
            leftBase.position.set(-poleX, -2, 0);
            leftBase.receiveShadow = true;
            scene.add(leftBase);
            poles.push(leftBase);
            
            // Right pole (Orange - Wave 2 source)
            const rightPoleMat = new THREE.MeshStandardMaterial({ 
                color: 0xF59E0B,
                emissive: 0xF59E0B,
                emissiveIntensity: 0.2,
                metalness: 0.8,
                roughness: 0.2
            });
            const rightPole = new THREE.Mesh(poleGeometry, rightPoleMat);
            rightPole.position.set(poleX, poleHeight / 2 - 2, 0);
            rightPole.castShadow = true;
            scene.add(rightPole);
            poles.push(rightPole);
            
            const rightBase = new THREE.Mesh(baseGeometry, rightPoleMat);
            rightBase.position.set(poleX, -2, 0);
            rightBase.receiveShadow = true;
            scene.add(rightBase);
            poles.push(rightBase);
            
            // Add glowing rings at top of poles
            const ringGeometry = new THREE.TorusGeometry(poleRadius + 0.1, 0.05, 16, 100);
            
            const leftRing = new THREE.Mesh(ringGeometry, new THREE.MeshBasicMaterial({ 
                color: 0x3B82F6,
                transparent: true,
                opacity: 0.8
            }));
            leftRing.position.set(-poleX, poleHeight - 2, 0);
            leftRing.rotation.x = Math.PI / 2;
            scene.add(leftRing);
            poles.push(leftRing);
            
            const rightRing = new THREE.Mesh(ringGeometry, new THREE.MeshBasicMaterial({ 
                color: 0xF59E0B,
                transparent: true,
                opacity: 0.8
            }));
            rightRing.position.set(poleX, poleHeight - 2, 0);
            rightRing.rotation.x = Math.PI / 2;
            scene.add(rightRing);
            poles.push(rightRing);
            
            // Add source indicators (glowing spheres)
            const sourceGeometry = new THREE.SphereGeometry(0.4, 32, 32);
            
            const leftSource = new THREE.Mesh(sourceGeometry, new THREE.MeshBasicMaterial({ 
                color: 0x3B82F6,
                transparent: true,
                opacity: 0.9
            }));
            leftSource.position.set(-poleX, 0, 0);
            scene.add(leftSource);
            poles.push(leftSource);
            
            const rightSource = new THREE.Mesh(sourceGeometry, new THREE.MeshBasicMaterial({ 
                color: 0xF59E0B,
                transparent: true,
                opacity: 0.9
            }));
            rightSource.position.set(poleX, 0, 0);
            scene.add(rightSource);
            poles.push(rightSource);
        }
        
        function createAxisLabels() {
            // X-axis label
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;
            context.fillStyle = '#94a3b8';
            context.font = 'bold 24px Inter';
            context.textAlign = 'center';
            context.fillText('x (m)', 64, 40);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.set(12, -3.5, 0);
            sprite.scale.set(4, 2, 1);
            scene.add(sprite);
            
            // Y-axis label
            const canvasY = document.createElement('canvas');
            const contextY = canvasY.getContext('2d');
            canvasY.width = 128;
            canvasY.height = 64;
            contextY.fillStyle = '#94a3b8';
            contextY.font = 'bold 24px Inter';
            contextY.textAlign = 'center';
            contextY.fillText('y (m)', 64, 40);
            
            const textureY = new THREE.CanvasTexture(canvasY);
            const spriteMaterialY = new THREE.SpriteMaterial({ map: textureY });
            const spriteY = new THREE.Sprite(spriteMaterialY);
            spriteY.position.set(-12, 3, 0);
            spriteY.scale.set(4, 2, 1);
            scene.add(spriteY);
        }

        function createWaveString() {
            // Remove existing particles
            waveParticles.forEach(p => scene.remove(p.mesh));
            waveParticles2.forEach(p => scene.remove(p.mesh));
            waveParticles = [];
            waveParticles2 = [];
            
            const geometry = new THREE.SphereGeometry(0.12, 16, 16);
            
            // Wave 1 particles (from left, blue)
            for (let i = 0; i < NUM_PARTICLES; i++) {
                const x = (i - NUM_PARTICLES / 2) * PARTICLE_SPACING;
                
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x3B82F6,
                    emissive: 0x3B82F6,
                    emissiveIntensity: 0.4,
                    roughness: 0.3,
                    metalness: 0.7
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(x, 0, 0);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                
                scene.add(mesh);
                
                waveParticles.push({
                    mesh: mesh,
                    baseX: x,
                    baseY: 0,
                    baseZ: 0,
                    index: i
                });
            }
            
            // Wave 2 particles (from right, orange) - for collision mode
            for (let i = 0; i < NUM_PARTICLES; i++) {
                const x = (i - NUM_PARTICLES / 2) * PARTICLE_SPACING;
                
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xF59E0B,
                    emissive: 0xF59E0B,
                    emissiveIntensity: 0.4,
                    roughness: 0.3,
                    metalness: 0.7,
                    transparent: true,
                    opacity: 0.7
                });
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(x, 0, 0);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.visible = false; // Hidden in single mode
                
                scene.add(mesh);
                
                waveParticles2.push({
                    mesh: mesh,
                    baseX: x,
                    baseY: 0,
                    baseZ: 0,
                    index: i
                });
            }
            
            updateWaveLine();
        }
        
        function createEquilibriumLine() {
            const points = [];
            for (let i = 0; i <= NUM_PARTICLES; i++) {
                const x = (i - NUM_PARTICLES / 2) * PARTICLE_SPACING;
                points.push(new THREE.Vector3(x, 0, 0));
            }
            
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ 
                color: 0x10B981, 
                opacity: 0.2, 
                transparent: true,
                linewidth: 2
            });
            
            const line = new THREE.Line(geometry, material);
            line.name = 'equilibriumLine';
            scene.add(line);
        }
        
        let waveLine1 = null;
        let waveLine2 = null;
        
        function updateWaveLine() {
            // Update wave 1 line
            if (waveLine1) {
                scene.remove(waveLine1);
                waveLine1.geometry.dispose();
                waveLine1.material.dispose();
            }
            
            const points1 = waveParticles.map(p => p.mesh.position.clone());
            const geometry1 = new THREE.BufferGeometry().setFromPoints(points1);
            
            const colors1 = [];
            for (let i = 0; i < waveParticles.length; i++) {
                colors1.push(0.23, 0.51, 0.96); // Blue
            }
            geometry1.setAttribute('color', new THREE.Float32BufferAttribute(colors1, 3));
            
            const material1 = new THREE.LineBasicMaterial({ 
                vertexColors: true,
                opacity: 0.9, 
                transparent: true,
                linewidth: 3
            });
            
            waveLine1 = new THREE.Line(geometry1, material1);
            scene.add(waveLine1);
            
            // Update wave 2 line (collision mode)
            if (waveLine2) {
                scene.remove(waveLine2);
                waveLine2.geometry.dispose();
                waveLine2.material.dispose();
            }
            
            if (waveParams.mode === 'collision') {
                const points2 = waveParticles2.map(p => p.mesh.position.clone());
                const geometry2 = new THREE.BufferGeometry().setFromPoints(points2);
                
                const colors2 = [];
                for (let i = 0; i < waveParticles2.length; i++) {
                    colors2.push(0.96, 0.62, 0.04); // Orange
                }
                geometry2.setAttribute('color', new THREE.Float32BufferAttribute(colors2, 3));
                
                const material2 = new THREE.LineBasicMaterial({ 
                    vertexColors: true,
                    opacity: 0.7, 
                    transparent: true,
                    linewidth: 3
                });
                
                waveLine2 = new THREE.Line(geometry2, material2);
                scene.add(waveLine2);
            }
        }

        function updatePhysics() {
            if (isPaused) return;
            
            time += 0.016;
            
            const omega = 2 * Math.PI * waveParams.frequency;
            const k = waveParams.waveNumber;
            const A = waveParams.amplitude;
            
            // Calculate wave speed
            const waveSpeed = Math.sqrt(waveParams.tension / waveParams.density);
            
            // Wave 1: traveling right (from left pole)
            waveParticles.forEach((particle, i) => {
                const x = particle.baseX;
                const phase = k * x - omega * time + waveParams.phase;
                
                if (waveParams.type === 'transverse') {
                    const y = A * Math.sin(phase);
                    particle.mesh.position.set(x, y, 0);
                    
                    const normalizedY = y / A;
                    const intensity = 0.4 + Math.abs(normalizedY) * 0.5;
                    particle.mesh.material.emissiveIntensity = intensity;
                } else {
                    const displacement = A * Math.sin(phase);
                    particle.mesh.position.set(x + displacement, 0, 0);
                    
                    const compression = -Math.cos(phase);
                    const scale = 1 + compression * 0.3;
                    particle.mesh.scale.set(scale, scale, scale);
                }
            });
            
            // Wave 2: traveling left (from right pole) - for collision mode
            if (waveParams.mode === 'collision') {
                waveParticles2.forEach((particle, i) => {
                    const x = particle.baseX;
                    // Wave traveling in opposite direction: +kx + œât
                    const phase = k * x + omega * time + waveParams.phase;
                    
                    if (waveParams.type === 'transverse') {
                        const y = A * Math.sin(phase);
                        particle.mesh.position.set(x, y, 0);
                        
                        const normalizedY = y / A;
                        const intensity = 0.4 + Math.abs(normalizedY) * 0.5;
                        particle.mesh.material.emissiveIntensity = intensity;
                    } else {
                        const displacement = A * Math.sin(phase);
                        particle.mesh.position.set(x + displacement, 0, 0);
                        
                        const compression = -Math.cos(phase);
                        const scale = 1 + compression * 0.3;
                        particle.mesh.scale.set(scale, scale, scale);
                    }
                });
                
                // Check for collision
                checkWaveCollision();
            }
            
            updateWaveLine();
            checkMissions();
        }
        
        function checkWaveCollision() {
            // Check if waves are meeting near the center
            const centerIndex = Math.floor(NUM_PARTICLES / 2);
            const collisionThreshold = 5; // Number of particles around center to check
            
            let wavesMeeting = false;
            
            for (let i = centerIndex - collisionThreshold; i <= centerIndex + collisionThreshold; i++) {
                if (i >= 0 && i < NUM_PARTICLES) {
                    const p1 = waveParticles[i];
                    const p2 = waveParticles2[i];
                    
                    if (waveParams.type === 'transverse') {
                        // Check if both waves have significant displacement
                        if (Math.abs(p1.mesh.position.y) > waveParams.amplitude * 0.3 &&
                            Math.abs(p2.mesh.position.y) > waveParams.amplitude * 0.3) {
                            wavesMeeting = true;
                            break;
                        }
                    } else {
                        // For longitudinal, check displacement from base
                        const disp1 = Math.abs(p1.mesh.position.x - p1.baseX);
                        const disp2 = Math.abs(p2.mesh.position.x - p2.baseX);
                        if (disp1 > waveParams.amplitude * 0.3 && disp2 > waveParams.amplitude * 0.3) {
                            wavesMeeting = true;
                            break;
                        }
                    }
                }
            }
            
            if (wavesMeeting) {
                if (!collisionDetected) {
                    collisionDetected = true;
                    document.getElementById('collisionIndicator').classList.add('show');
                    
                    // Complete mission
                    if (!missions.mission5) {
                        completeMission('mission5');
                    }
                }
                collisionTimer = 30; // Show indicator for ~0.5 seconds
            } else if (collisionTimer > 0) {
                collisionTimer--;
                if (collisionTimer <= 0) {
                    collisionDetected = false;
                    document.getElementById('collisionIndicator').classList.remove('show');
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            updatePhysics();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function setupUI() {
            // Parameter sliders
            document.getElementById('amplitude').addEventListener('input', (e) => {
                waveParams.amplitude = parseFloat(e.target.value);
                document.getElementById('valAmplitude').textContent = waveParams.amplitude.toFixed(1) + ' m';
            });
            
            document.getElementById('frequencyInput').addEventListener('input', (e) => {
                waveParams.frequency = parseFloat(e.target.value);
                document.getElementById('valFrequency').textContent = waveParams.frequency.toFixed(1) + ' Hz';
                updateCalculations();
            });
            
            document.getElementById('waveNumber').addEventListener('input', (e) => {
                waveParams.waveNumber = parseFloat(e.target.value);
                document.getElementById('valWaveNumber').textContent = waveParams.waveNumber.toFixed(1) + ' rad/m';
                updateCalculations();
            });
            
            document.getElementById('tension').addEventListener('input', (e) => {
                waveParams.tension = parseFloat(e.target.value);
                document.getElementById('valTension').textContent = waveParams.tension.toFixed(0) + ' N';
                updateCalculations();
            });
            
            document.getElementById('density').addEventListener('input', (e) => {
                waveParams.density = parseFloat(e.target.value);
                document.getElementById('valDensity').textContent = waveParams.density.toFixed(2) + ' kg/m';
                updateCalculations();
            });
        }
        
        function updateCalculations() {
            const waveSpeed = Math.sqrt(waveParams.tension / waveParams.density);
            document.getElementById('calcSpeed').textContent = waveSpeed.toFixed(1);
            document.getElementById('waveSpeed').textContent = waveSpeed.toFixed(1);
            
            const calculatedFreq = (waveSpeed * waveParams.waveNumber) / (2 * Math.PI);
            document.getElementById('frequency').textContent = calculatedFreq.toFixed(2);
            
            const wavelength = (2 * Math.PI) / waveParams.waveNumber;
            document.getElementById('wavelength').textContent = wavelength.toFixed(2);
        }
        
        function setWaveType(type) {
            waveParams.type = type;
            
            document.getElementById('btnTransverse').classList.toggle('active', type === 'transverse');
            document.getElementById('btnLongitudinal').classList.toggle('active', type === 'longitudinal');
            
            waveParticles.forEach(p => p.mesh.scale.set(1, 1, 1));
            waveParticles2.forEach(p => p.mesh.scale.set(1, 1, 1));
            
            if (type === 'longitudinal' && !missions.mission3) {
                completeMission('mission3');
            }
        }
        
        function setWaveMode(mode) {
            waveParams.mode = mode;
            
            document.getElementById('btnSingle').classList.toggle('active', mode === 'single');
            document.getElementById('btnCollision').classList.toggle('active', mode === 'collision');
            
            // Toggle visibility of wave 2
            waveParticles2.forEach(p => {
                p.mesh.visible = (mode === 'collision');
            });
            
            if (mode === 'single' && waveLine2) {
                waveLine2.visible = false;
            }
        }
        
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂ Play' : '‚è∏ Pause';
        }

        function resetSimulation() {
            time = 0;
            collisionDetected = false;
            document.getElementById('collisionIndicator').classList.remove('show');
            
            waveParams = {
                type: 'transverse',
                mode: 'single',
                amplitude: 0.5,
                frequency: 1.0,
                waveNumber: 2.0,
                tension: 10,
                density: 0.1,
                phase: 0
            };
            
            // Reset UI
            document.getElementById('amplitude').value = 0.5;
            document.getElementById('frequencyInput').value = 1.0;
            document.getElementById('waveNumber').value = 2.0;
            document.getElementById('tension').value = 10;
            document.getElementById('density').value = 0.1;
            
            document.getElementById('valAmplitude').textContent = '0.5 m';
            document.getElementById('valFrequency').textContent = '1.0 Hz';
            document.getElementById('valWaveNumber').textContent = '2.0 rad/m';
            document.getElementById('valTension').textContent = '10 N';
            document.getElementById('valDensity').textContent = '0.1 kg/m';
            
            setWaveType('transverse');
            setWaveMode('single');
            updateCalculations();
            
            // Reset missions
            Object.keys(missions).forEach(key => {
                missions[key] = false;
                document.getElementById(key).classList.remove('completed');
                document.getElementById(key.replace('mission', 'missionItem')).classList.remove('completed');
            });
            
            document.getElementById('successOverlay').style.display = 'none';
        }

        function checkMissions() {
            const wavelength = (2 * Math.PI) / waveParams.waveNumber;
            const waveSpeed = Math.sqrt(waveParams.tension / waveParams.density);
            
            if (wavelength > 3 && !missions.mission1) {
                completeMission('mission1');
            }
            
            if (waveSpeed > 5 && !missions.mission2) {
                completeMission('mission2');
            }
            
            if (waveParams.frequency > 2 && waveParams.waveNumber > 2.5 && !missions.mission4) {
                completeMission('mission4');
            }
        }

        function completeMission(id) {
            if (missions[id]) return;
            
            missions[id] = true;
            document.getElementById(id).classList.add('completed');
            document.getElementById(id.replace('mission', 'missionItem')).classList.add('completed');
            
            confetti({ 
                particleCount: 150, 
                spread: 80, 
                origin: { y: 0.6 },
                colors: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B']
            });
        }
        
        function openHintModal() {
            document.getElementById('hintModal').style.display = 'flex';
        }
        
        function closeHintModal() {
            document.getElementById('hintModal').style.display = 'none';
        }
        
        // Close modal on outside click
        document.getElementById('hintModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('hintModal')) {
                closeHintModal();
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
